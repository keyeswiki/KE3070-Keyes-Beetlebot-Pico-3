# 项目17 WIFI控制点阵屏

## 1. 实验简介：
在前面的项目16中，我们已经知道ESP8266串口WiFi ESP-01模块通过WiFi测试代码得到相关的WiFi信息。那么在本项目中，我们将使用ESP8266串口WiFi ESP-01模块通过APP和WiFi来控制小车上8*8点阵。

## 2. 安装APP：

**安卓系统设备（手机/平板）APP：**

1.下载Beetlebot.apk文件

A. 我们提供了Android APP 的安装包：
![Img](../../media/项目17-1img-20230601111654.png)
现将文件夹中的Beetlebot.apk文件转移到安卓系统手机或平板上。

B. 或者，使用手机浏览器中的扫描功能去扫二维码下载APP。
![Img](../../media/项目17-2img-20230506145736.png)

2.点击Beetlebot.apk文件进入安装页面，点击“允许”按钮，然后再点击“继续安装”按钮，安装完成后点击“打开”按钮就可以进入APP界面。
![Img](../../media/项目17-3img-20230506150200.png)
![Img](../../media/项目17-4img-20230506150422.png)
![Img](../../media/项目17-5img-20230506150539.png)
![Img](../../media/项目17-6img-20230330152214.png)

**IOS系统设备（手机/iPad）APP**
a.打开App Store。
![Img](../../media/项目17-7img-20230330152300.png)
b.在搜索框输入“**Beetlebot**”，点击搜索，出现下载界面，点击“![Img](../../media/项目17-8img-20230330152329.png)”，就可以下载安装Beetlebot的APP。接下来的操作和安卓系统类似的，可以参考上面安卓系统的步骤进行操作。

## 3. 将WIFI模块串口测试扩展板插入电脑的USB口：
A. 将ESP8266串口WIFI ESP-01模块正确方向插入USB转ESP-01S WIFI模块串口测试扩展板上。
![Img](../../media/项目17-9img-20230531162927.png)
B. 先将USB转ESP-01S WIFI模块串口测试扩展板上的<span style="color: rgb(0, 209, 0);">拨码开关</span>拨到<span style="color: rgb(255, 76, 65);">Uart Download</span>端，再将USB转ESP-01S WIFI模块串口测试扩展板插入电脑的USB口。
![Img](../../media/项目17-10img-20230531163028.png)

## 4. ESP8266 代码：
<span style="color: rgb(255, 76, 65);">注意：打开Arduino IDE后，一定要先设置好ESP8266板型和COM口（设置方法参照前面 **<span style="color: rgb(61, 167, 66);">项目16 WIFI 测试</span>**）。手机和设备需要连接在同一个WiFi上，如果家里没有WiFi需要打开手机热点共享WiFi，打开手机热点共享WiFi是最好的方法。</span>

```
//**********************************************************************************
/*
ESP8266_Code
*/
// generated by KidsBlock
#include <Arduino.h>
#include <ESP8266WiFi.h>
#include <ESP8266mDNS.h>
#include <WiFiClient.h>
//#include <WiFi.h>

#ifndef STASSID
#define STASSID "ChinaNet_2.4G"  //用户的Wifi名称
#define STAPSK  "ChinaNet@233"   //用户的wifi密码
#endif
const char* ssid = STASSID;
const char* password = STAPSK;

//IPAddress local_IP(192,168,4,22);
//IPAddress gateway(192,168,4,22);
//IPAddress subnet(255,255,255,0);
//
//const char *ssid = "ESP8266_AP_TEST";
//const char *password = "12345678";

WiFiServer server(80);
String unoData = "";
int ip_flag = 0;
int ultra_state = 1;
String ip_str;


void setup() {
  Serial.begin(9600); 
//   WiFi.mode(WIFI_AP); //设置工作在AP模式
//
//  WiFi.softAPConfig(local_IP, gateway, subnet); //设置AP地址
//  while(!WiFi.softAP(ssid, password)){}; //启动AP
//  Serial.println("AP启动成功");
//
//  Serial.print("IP address: ");
//  Serial.println(WiFi.softAPIP()); // 打印IP地址
//
//  WiFi.softAPsetHostname("myHostName"); //设置主机名
//  Serial.print("HostName: ");
//  Serial.println(WiFi.softAPgetHostname()); //打印主机名
//
//  Serial.print("mac Address: ");
//  Serial.println(WiFi.softAPmacAddress()); //打印mac地址

  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.print("IP ADDRESS: ");
  Serial.println(WiFi.localIP());
  if (!MDNS.begin("esp8266")) {
    //Serial.println("Error setting up MDNS responder!");
    while (1) {
      delay(1000);
    }
  }
 // Serial.println("mDNS responder started");
  server.begin();
  //Serial.println("TCP server started");
  MDNS.addService("http", "tcp", 80);
  ip_flag = 1;
}

void loop() {
  //Serial.println(WiFi.softAPgetStationNum()); //打印客户端连接数
  if(ip_flag == 1)
  {
    for(int i=3; i>0; i--)
    {
      Serial.print("IP: ");
      Serial.print(WiFi.localIP());
      Serial.println('#');
      delay(500);
    }
    ip_flag = 0;
    
  }
    MDNS.update();
    WiFiClient client = server.available();
    if (!client) {
      return;
    }
    //Serial.println("");
    while (client.connected() && !client.available()) {
      delay(1);
    }
    String req = client.readStringUntil('\r');
    int addr_start = req.indexOf(' ');
    int addr_end = req.indexOf(' ', addr_start + 1);
    if (addr_start == -1 || addr_end == -1) {
      //Serial.print("Invalid request: ");
      //Serial.println(req);
      return;
    }
    req = req.substring(addr_start + 1, addr_end);
    int len_val = String(req).length();
    String M_req = String(req).substring(0,6);
    //Serial.println(M_req);
    if(M_req == "/btn/u")
    {
      String s_M_req = String(req).substring(5,len_val);
      Serial.print(s_M_req);
      Serial.print("#");
    }
    if(M_req == "/btn/v")
    {
      String s_M_req = String(req).substring(5,len_val);
      Serial.print(s_M_req);
      Serial.print("#");
    }
    client.flush();
    String s;
    if (req == "/") {
      IPAddress ip = WiFi.localIP();
      String ipStr = String(ip[0]) + '.' + String(ip[1]) + '.' + String(ip[2]) + '.' + String(ip[3]);
      s = "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n<!DOCTYPE HTML>\r\n<html>Hello from ESP8266 at ";
      s += ipStr;
      s += "</html>\r\n\r\n";
      //Serial.println("Sending 200");
      Serial.println(WiFi.localIP());
      Serial.write('*');
      client.println(WiFi.localIP());
      ip_flag = 0;
    }
    else if(req == "/btn/F")
    {
      Serial.write('F');
      client.println(F("F"));
    }
    else if(req == "/btn/B")
    {
      Serial.write('B');
      client.println(F("B"));
    }
    else if(req == "/btn/L")
    {
      Serial.write('L');
      client.println(F("L"));
    }
    else if(req == "/btn/R")
    {
      Serial.write('R');
      client.println(F("R"));
    }
    else if(req == "/btn/S")
    {
      Serial.write('S');
      client.println(F("S"));
    }
    else if(req == "/btn/a")
    {
      Serial.write('a');
      client.println(F("a"));
    }
    else if(req == "/btn/b")
    {
      Serial.write('b');
      client.println(F("b"));
    }
    else if(req == "/btn/c")
    {
      Serial.write('c');
      client.println(F("c"));
    }
    else if(req == "/btn/d")
    {
      Serial.write('d');
      client.println(F("d"));
    }
    else if(req == "/btn/e")
    {
      Serial.write('e');
      client.println(F("e"));
    }
    else if(req == "/btn/f")
    {
      Serial.write('f');
      client.println(F("f"));
    }
    else if(req == "/btn/g")
    {
      Serial.write('g');
      client.println(F("g"));
    }
    else if(req == "/btn/z")
    {
      Serial.write('z');
      client.println(F("z"));
    }
    else if(req == "/btn/i")
    {
      Serial.write('i');
      client.println(F("i"));
    }
    else if(req == "/btn/j")
    {
      Serial.write('j');
      client.println(F("j"));
    }
    else if(req == "/btn/k")
    {
      Serial.write('k');
      client.println(F("k"));
    }
    else if(req == "/btn/y")
    {
      Serial.write('y');
      client.println(F("y"));
    }
    else if(req == "/btn/l")
    {
      Serial.write('l');
      client.println(F("l"));
    }
    else if(req == "/btn/m")
    {
      Serial.write('m');
      client.println(F("m"));
    }
    else if(req == "/btn/n")
    {
      Serial.write('n');
      client.println("n");
    }
    else if(req == "/btn/o")
    {
      Serial.write('o');
      client.println(F("o"));
    }
    else if(req == "/btn/p")
    {
      Serial.write('p');
      client.println(F("p"));
    }
    else if(req == "/btn/q")
    {
      Serial.write('q');
      client.println("q");
    }
    else if(req == "/btn/x")
    {
      Serial.write('x');
      client.println(F("x"));
    }
    else if(req == "/btn/1")
    {
      Serial.write('1');
      client.println(F("1"));
    }
    else if(req == "/btn/2")
    {
      Serial.write('2');
      client.println("2");
    }
    else if(req == "/btn/3")
    {
      Serial.write('3');
      client.println(F("3"));
    }
    else if(req == "/btn/4")
    {
      Serial.write('4');
      client.println("4");
    }
    else if(req == "/btn/5")
    {
      Serial.write('5');
      client.println(F("5"));
    }
    else if(req == "/btn/0")
    {
      Serial.write('0');
      client.println("0");
    }
    else {
      //s = "HTTP/1.1 404 Not Found\r\n\r\n";
      //Serial.println("Sending 404");
    }

    client.print(F("IP : "));
    client.println(WiFi.localIP());
}
//**********************************************************************************
```

**<span style="color: rgb(255, 76, 65);">特别注意：需要先将实验代码![Img](../../media/项目17-11img-20230601101103.png)中的用户Wifi名称和用户Wifi密码改成你们自己的Wifi名称和Wifi密码。</span>**

Wifi名称和Wifi密码修改后，确保USB转ESP-01S WiFi模块串口测试扩展板上的拨码开关已经拨到Uart Download 端，并且也确定USB转ESP-01S WIFI模块串口测试扩展板已经插入电脑的USB口。然后按照<span style="color: rgb(255, 76, 65);">**项目16 WIFI 测试**</span>中的方法设置ESP8266板型和COM口，IDE右下角会显示对应的ESP8266板型和COM口，再点击![Img](../../media/上传按钮img-20230506095425.png)将ESP8266 代码上传到ESP8266串口WIFI ESP-01模块上，上传成功。
（<span style="color: rgb(255, 76, 65);">注意：</span>如果上传失败，在板型和COM口没问题情况下，将USB转ESP-01S WIFI模块串口测试扩展板从电脑的USB口拔下来再次插到电脑的USB口）。
![Img](../../media/项目17-12img-20230601105102.png)

ESP8266 代码上传成功后，先将USB转ESP-01S WiFi模块串口测试扩展板从电脑的USB口拔下来，再将ESP8266串口WIFI ESP-01模块从USB转ESP-01S WiFi模块串口测试扩展板上拔下来。

## 5. WiFi控制点阵屏的实验代码：
<span style="color: rgb(255, 76, 65);">注意：打开Arduino IDE后，一定要先设置好Raspberry Pi Pico板型和COM口（设置方法参照“**开发环境设置**”文件）。如果家里没有WiFi需要打开手机热点共享WiFi。</span>

```
//**********************************************************************************
/*
项目 17 WiFi 控制点阵屏
*/
#include <Matrix_pico.h>
Matrix myMatrix(20,21);//定义GPIO20,GPIO21中的点阵引脚。
//数组，用于存储模式的数据，可以自己计算或从触摸工具检索
uint8_t Heart_LedArray[8]={0x00, 0x66, 0x99, 0x81, 0x42, 0x24, 0x18, 0x00};
uint8_t Ten_LedArray[8]={0x18, 0x18, 0x18, 0xff, 0xff, 0x18, 0x18, 0x18};
uint8_t Smile_LedArray[8]={0x00, 0xc3, 0x00, 0x00, 0x18, 0x81, 0x42, 0x3c};
uint8_t  LEDArray[8];
char wifiData;

void setup() {
  Serial1.begin(9600);
  myMatrix.begin(0x70);
  myMatrix.clear();
  myMatrix.write();
}

void loop() {
  if(Serial1.available() > 0)
  {
    wifiData = Serial1.read();
    Serial.print(wifiData);
    if(wifiData == '#')
    {
      Serial.println("");
    }
    delay(100);
    
    if(wifiData == 'i')
    {
      myMatrix.clear();
      myMatrix.write();
      matrix_display(Smile_LedArray); 
    }
    else if(wifiData == 'j')
    {
      myMatrix.clear();
      myMatrix.write();
      matrix_display(Ten_LedArray);
    }
    else if(wifiData == 'k')
    {
      myMatrix.clear();
      myMatrix.write();
      matrix_display(Heart_LedArray);
    }
    }
  }

//点阵显示模式函数
void matrix_display(unsigned char matrix_value[])
{
  for(int i=0; i<8; i++)
    {
      LEDArray[i]=matrix_value[i];
      for(int j=7; j>=0; j--)
      {
        if((LEDArray[i]&0x01)>0)
        myMatrix.drawPixel(j, i,1);
        LEDArray[i] = LEDArray[i]>>1;
      }
    } 
    myMatrix.write();
}
//**********************************************************************************

```
## 6.实验现象：
<span style="color: rgb(255, 76, 65);">特别注意：</span>安上电池，并且将小车底板上的电源开关拨到ON端，需要先将实验代码上传至Raspberry Pi Pico，上传成功后，再将ESP8266串口WiFi ESP-01模块按正确地方向插入小车上。
![Img](../../media/WiFi-ESP-01模块插入小车img-20230531091958.png)

打开Arduino IDE，点击Arduino IDE页面上菜单栏的"工具" → "开发板："，选择“Raspberry Pi Pico”，选择正确的COM端口（<span style="color: rgb(255, 76, 65);">设置方法参照“**开发环境设置**”文件</span>），最后将实验代码上传至Raspberry Pi Pico主板。上传代码成功后，再将接在ESP8266串口WIFI ESP-01模块正确地方向插入小车的WiFi处，点击![Img](../../media/项目17-14img-20230601115900.png)打开串口监视器窗口，将波特率设置为9600。这样，串口监视器就显示此时你们WiFi的IP地址。
（<span style="color: rgb(0, 209, 0);">WiFi的IP地址有时候会改变，如果原来的IP地址不行，需要重新检测WiFi的IP地址</span>）
![Img](../../media/项目17-15img-20230601120221.png)
![Img](../../media/项目17-16img-20230601120756.png)
![Img](../../media/项目17-17img-20230601120844.png)
![Img](../../media/项目17-18img-20230601121116.png)

打开APP，在WiFi按钮前面的文本框中输入检测到的WiFi IP地址（例如，上面串口监视器检测到的IP地址：192.168.0.15），再切换WiFi按钮来连接WiFi（白色WIFI按钮变成绿色WIFI按钮），同时WiFi IP地址前的文本框中会显示对应的WiFi IP地址“192.168.0.15”。这样，就说明APP已经连接上了WiFi。
![Img](../../media/APP界面img-20230601133010.png)

<span style="color: rgb(255, 76, 65);">注意：</span>在文本框中输入检测到的WiFi IP地址，将白色WIFI按钮切换成绿色WIFI按钮，ESP8266串口WIFI ESP-01模块上的蓝色指示灯会闪烁，出现指示灯闪烁最亮的时候说明APP已经连接上WIFI。如果没有连接上WiFi，需要反复地连。

<br>
<br>

**APP已经连接上了WIFI后，开始进行如下操作：**

点击![Img](../../media/项目17-19img-20230330154408.png)按钮，小车前面的8×8点阵显示“微笑”图案；点击![Img](../../media/项目17-20img-20230330154416.png)按钮，小车前面的8×8点阵显示“十”图案；点击![Img](../../media/项目17-21img-20230330154423.png)按钮，小车前面的8×8点阵显示“❤”图案。
![Img](../../media/项目18-3img-20230721193135.png)
![Img](../../media/项目18-4img-20230721194853.png)
![Img](../../media/项目18-5img-20230725103430.png)
![Img](../../media/项目18-6img-20230721194920.png)











